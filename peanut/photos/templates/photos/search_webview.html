{% load dictionary_extras %}

<!DOCTYPE html> 
<html> 

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<title>Search your photos</title> 
	<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
<style>
	html, body { padding: 0; margin: 0; }
	html, .ui-mobile, .ui-mobile body {
	}
	.ui-mobile, .ui-mobile .ui-page {
	}
	.ui-content{
		padding:0px 0px 0px 0px;
	}
	.ui-filter-inset {
		margin-top: 0;
	}
	.input-search {
		height: 2em;
		font-size: 12px;
		text-align: left;
		background: none;
		width: 98%;
		border-width: 1px;
		background: #ffffff;
		margin-left: 2px;
		padding-left: 10px;	
	}
	.ui-gallery{
		/*overflow: auto;*/
	}
	.ui-photo-block {
		float: left;
		width: 100%;
	}
	.ui-time-header {
		font-family: arial;
		padding: 4px 0px 4px 10px;
		background-color: #F0F0F0;
	}
	.ui-image {
		padding-right: 2px;
		height: {{ imageSize|add:+2 }}px;
		float:left;
	}
	.text {
		font-family: arial;
	}
	.hidden {
		display: none;
	}
	.fixed-pos {
		position: fixed;
		top: 0px;
		left: 0px;
		width: 100%;
	}

	a:link{
		text-decoration: none;
		font-weight: bold;
		color: #0000FF;
	}
	a.visited {
		text-decoration: none;
		font-weight: bold;
		color: #0000FF;	
	}
	</style>
</head>

<body>

<div role="main" class="ui-content" style="height:2000px">
	{% if searchBox == True %}
		<form class="searchform" id="searchform">
			<div class="ui-input-search" id="searchbox">
				<input type="text" class="input-search" id="input-search" 
				value="{% if query %} {{ query }} {% else %} Search for time, location or things {% endif %}" />
			</div>
		</form>

	{% endif %}

	<div class="ui-gallery" id="allImages">
	{% for entry in resultsDict.photoResults %}
		{% include "photos/_timeline_block.html" %}
	{% endfor %}

	</div>

	<div class="result-bottom"> 
		{% if resultsDict.resultSize == 0 %}
			<p class="text"> No results found! </p>
		{% endif %}
	</div>

</div>

</body>
	<script>

		function loadImages() {
			$('#allImages').children().each(function(){
				$(this).removeClass('hidden');
				$(this).find('img.lazy').each(function() {
					$(this).attr('src', $(this).attr('data-lazy-src'));	
				});
			});
		}
		loadImages();
		var oldVal = "";

		$("#input-search").on("keyup paste", function(){
			if ($(this).val() == oldVal) {
				return;
			}
			oldVal = $(this).val();
			html ="";
			value = $(this).val();

			if (value && value.length > 1) {
				// TODO: change next line to show a loader in the searchbox
				//$('#allImages').html( "<div class='ui-loader'> Loading...</div>" );
				//$('#allImages').listview( "refresh" );
				query = $(this).val();
				console.log("sending query..." + query);
				
				$.ajax({
					url: "/api/search",
					dataType: "json",
					crossDomain: true,
					data: {
						user_id: "{{ user.id }}",
						q: query,
						debug: '{{ debug }}',
					}
				})
				.then(function(response) {
					$.each(response['_timeline_block_html'], function ( i, val ) {
						html += val;
					});
					$('#allImages').html(html);
					//$('#allImages').listview( "refresh" );
					//$ul.trigger( "updatelayout");
					loadImages();
				});
			}
		});

		var fixDivRunning = false;
		function fixDiv() {
			if (fixDiv == true) {
				return;
			}
			fixDivRunning = true;
			console.log("window scrolltop: " + $(window).scrollTop());
			var currentFloatId = -1;
			for (var i=0; i< $('div.ui-photo-block').length; i++){
				var id = '#ui-photo-block-'+i;
				console.log($(id).offset());
				console.log($(id).height());
				if ($(window).scrollTop() - $(id).offset().top - $(id).height() >= 0){
					console.log("above the fold: " + $(id).attr('id'));
					$(id).children('div.ui-time-header').each(function(){
						$(this).removeClass('fixed-pos');
					});
				}
				else {
					if (currentFloatId < 0) {
						currentFloatId = i;
						$(id).children('div.ui-time-header').each(function(){
							console.log("position fixed for: " + i);
							$(this).addClass('fixed-pos');
						});
					}
					else {
						console.log("Not the top div: " + $(id).attr('id'));
						$(id).children('div.ui-time-header').each(function(){
								$(this).removeClass('fixed-pos');
						});
					}
				}

			}
			fixDivRunning = false;
		}
		//$(window).scroll(fixDiv);
		//fixDiv();
		</script>
</html>