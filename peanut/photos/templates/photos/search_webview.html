{% load dictionary_extras %}

<!DOCTYPE html> 
<html> 

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<meta name="mobile-web-app-capable" content="yes">
	<title>Search your photos</title> 
	<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
	<script src="http://asood123.no-ip.biz/static/jquery.jscroll.js"></script>
<style>
	html, body { padding: 0; margin: 0; }
	html, .ui-mobile, .ui-mobile body {
	}
	.ui-mobile, .ui-mobile .ui-page {
	}
	.ui-content{
		padding:0px 0px 0px 0px;
	}

	.ui-gallery{
		/*overflow: auto;*/
	}
	.ui-photo-block {
		float: left;
		width: 100%;
	}
	.ui-time-header {
		font-family: arial;
		font-size: 1em;
		padding: 4px 0px 4px 10px;
		background-color: #F0F0F0;
	}
	.ui-image {
		padding-right: 2px;
		float:left;
		position: relative;
		cursor: pointer;
		height: {{ imageSize|add:+2 }}px;
		width: {{ imageSize }}px;
	}
	.ui-image-count {
		position:absolute;
		background-color: transparent;
		top: 44px;
		left: 45px;
		font-size: 0.9em;
		text-align: right;
		width: 33px;
		height:33px;
		line-height: 50px;
		padding-right: 2px;
		color: rgb(245, 166, 35);
	}
	.ui-arrow-down {
		width: 0; 
		height: 0; 
		border-top: 25px solid transparent;
		border-left: 25px solid transparent;
		border-bottom: 25px solid #fff;
		position:absolute;
		top: 28px;
		left: 53px;
	}
	.ui-loader {

	}
	.ui-warning {
		background-color: rgba(241,155,43,0.7);
		padding: 5px 5px 5px 5px;
		font-size: 14px;
	}
	.text {
		font-family: sans-serif;
	}
	.center {
		text-align: center;
	}
	.hidden {
		display: none;
	}
	.fixed-pos {
		position: fixed;
		top: 0px;
		left: 0px;
		width: 100%;
	}
	.results-footer {
		float: left;
		margin: 0px 0px 0px 0px;
		width: 100%;
		border-top: 1px solid rgb(241,155,43);
		font-size: 10px;
		text-align: right;
	}
	#stats{
		text-align: right;
		font-size: 10px;
	}
	a:link{
		text-decoration: none;
		font-weight: bold;
		color: #0000FF;
	}
	a.visited {
		text-decoration: none;
		font-weight: bold;
		color: #0000FF;	
	}
	</style>
</head>

<body>

<div role="main" class="ui-content">
	{% if resultsDict.incompleteResults %}
		<div class='ui-warning text'>
		Incomplete searches for things like animals, food, etc. Get on WiFi to upload rest of your photos.
		</div>
	{% endif %}
	<div class="ui-gallery" id="allImages">
	{% for entry in resultsDict.photoResults %}
		{% include "photos/_timeline_block.html" %}
	{% endfor %}
	{% if resultsDict.nextLink %}
		<a class='jscroll-next' href= "{{ resultsDict.nextLink }}">Next</a>
	{% endif %}

	</div>

	<div class="results-footer"> 
		{% if resultsDict.totalResults == 0 %}
			<div class="text center"> No results found! </div>
			<br>
		{% endif %}
		<div class="text" > Your searchable images: {{ resultsDict.indexSize }}  </div>

		<div id="stats" class="text">
			<!-- STATS: Time: %(total_time).2fs | P: %(python_time).2fs | DB: %(db_time).2fs | Q: %(db_queries)d ENDSTATS -->
		</div>
	</div>

</div>

</body>
	<script>
		function loadImages() {
			$('#allImages').find('div.ui-photo-block.hidden').each(function(){
				$(this).find('img.lazy').each(function() {
					$(this).attr('src', $(this).attr('data-lazy-src'));	
				});
				clusterClickHandler($(this).find('div.ui-image'));
				$(this).removeClass('hidden');
				});
		}

		loadImages();

		/*
			used to display clusters
		*/
		
		function clusterClickHandler(clusters){
			clusters.click(function() {
				if ($(this).hasClass('cluster')) {
					$(this).removeClass('cluster');
					$(this).children('div').addClass('hidden');
					current = $(this).next()
					while (current.hasClass('hidden')){
						current.find('img.lazy-cluster').each(function() {
							$(this).attr('src', $(this).attr('data-lazy-src'));
						});
						current.show("fast");
						current.removeClass('hidden');
						current = current.next();
					}
				}
				else {
					window.location.href = $(this).attr('redirect')+'?photoIdArray='+photoIdArray().toString();
				}
			});
		}
		/*
			returns an array of photoIds that are currently open/expanded
		*/
		function photoIdArray(){
			var pArray = [];
			$('#allImages').find('div.ui-image').each(function(){
				if (!($(this).hasClass('hidden'))) {
					pArray.push($(this).attr('photoId'));
				}
			});
			return pArray;
		}	
		$('div.ui-gallery').jscroll({
			nextSelector: 'a.jscroll-next:last',
			debug: true,
			autoTrigger: true,
			callback: function(){
				loadImages();
			},
			loadingHtml: '<div class="ui-loader center text"> Loading... </p>'
		});
		</script>
</html>