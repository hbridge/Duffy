{% load dictionary_extras %}

<!DOCTYPE html> 
<html> 

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	{% if resultsDict.autoRefresh %}
		<meta http-equiv="refresh" content="3">
	{% endif %}
	<meta name="mobile-web-app-capable" content="yes">
	<title>Search your photos</title> 
	<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
	<script src="http://asood123.no-ip.biz/static/jquery.jscroll.js"></script>
<style>
	html, body { padding: 0; margin: 0; }
	.ui-content{
		padding:0px 0px 0px 0px;
	}
	.ui-photo-block {
		float: left;
		width: 100%;
	}
	.ui-time-header {
		font-family: arial;
		font-size: 1em;
		padding: 11px 0px 11px 10px;
		background-color: rgba(239, 239, 239, 0.3);
	}
	.i {
		padding-right: 2px;
		float:left;
		position: relative;
		cursor: pointer;
		height: {{ imageSize|add:+2 }}px;
		width: {{ imageSize }}px;
	}
	.ui-i-c {
		position:absolute;
		background-color: transparent;
		top: 44px;
		left: 45px;
		font-size: 0.9em;
		text-align: right;
		width: 33px;
		height:33px;
		line-height: 50px;
		padding-right: 2px;
		color: rgb(245, 166, 35);
	}
	.ui-a-d {
		width: 0; 
		height: 0; 
		border-top: 25px solid transparent;
		border-left: 25px solid transparent;
		border-bottom: 25px solid #fff;
		position:absolute;
		top: 28px;
		left: 53px;
	}
	.ui-warning {
		background-color: rgba(241,155,43,0.7);
		padding: 5px 5px 5px 5px;
		font-size: 14px;
	}
	.ui-more {
		padding: 11px 0px 11px 0px;
	}
	.ui-loader {
		padding: 11px 0px 11px 0px;
	}
	.ui-refresh {
		padding: 11px 10px 11px 10px;
		overflow: auto;
		background-color: rgba(241, 155, 43, 0.7);
	}
	.t {
		font-family: sans-serif;
	}
	.center {
		text-align: center;
	}
	.hidden {
		display: none;
	}
	.fixed-pos {
		position: fixed;
		top: 0px;
		left: 0px;
		width: 100%;
	}
	.results-footer {
		float: left;
		margin: 0px 0px 0px 0px;
		width: 100%;
		border-top: 1px solid rgb(239, 239, 239);
		font-size: 10px;
		text-align: left;
	}
	#stats{
	}
	a:link{
		text-decoration: none;
		font-weight: bold;
		color: #0000FF;
	}
	a.visited {
		text-decoration: none;
		font-weight: bold;
		color: #0000FF;	
	}
	</style>
</head>

<body>

<div role="main" class="ui-content">
	<div class='ui-refresh center t hidden'>
	More photos uploaded. Tap to Refresh!
	</div>
	
	{% if resultsDict.incompleteResults %}
		<div class='ui-warning t'>
		Incomplete searches for things like animals, food, etc. We are still uploading rest of your photos.
		</div>
	{% endif %}

	{% if resultsDict.reverse %}
	<div class="ui-more center t hidden">More</div>
	{% endif %}

	<div class="ui-gallery" id="allImages">

		{% for entry in resultsDict.photoResults %}
			{% include "photos/_timeline_block.html" %}
		{% endfor %}
		{% if resultsDict.nextLink %}
		<a class='jscroll-next' href= "{{ resultsDict.nextLink }}"></a>
		{% endif %}	
	</div>

	{% if not resultsDict.reverse %}
		<div class="ui-more center t hidden">More</div>
	{% endif %}	

	<div class="results-footer"> 
		{% if resultsDict.totalResults == 0 %}
			<div class="t center"> No results found! </div>
			<br>
		{% endif %}
		<div class="t"> Your searchable images: {{ resultsDict.indexSize }}  </div>
		<div class="t"> Last Update: {{ resultsDict.lastUpdated }} </div>
		<div id="stats" class="t">
			<!-- STATS: Time: %(total_time).2fs | P: %(python_time).2fs | DB: %(db_time).2fs | Q: %(db_queries)d ENDSTATS -->
		</div>
	</div>

</div>
</body>
	<script>

	{% if resultsDict.reverse %}
	var reversed  = true;
	{% else %}
	var reversed = false;
	{% endif %}

	/*
		returns an array of pIds that are currently open/expanded
	*/
	function photoIdArray(){
		var pArray = [];
		$('#allImages').find('div.i').each(function(){
			if (!($(this).hasClass('hidden'))) {
				pArray.push($(this).attr('pId'));
			}
		});
		return pArray;
	}	

	/*
		click handler for clusters and images
	*/
	function clusterClickHandler(clusters){
		clusters.click(function() {
			if ($(this).hasClass('cluster')) {
				$(this).removeClass('cluster');
				$(this).children('div').addClass('hidden'); // hides white triangle and cluster size
				current = $(this).next()
				while (current.hasClass('hidden')){
						current.find('img.l-c').each(function() {
						$(this).attr('src', $(this).attr('l-src'));
						$(this).removeClass('l-c');
					});					
					current.show("fast");
					current.removeClass('hidden');
					current = current.next();
				}
			}
			else {
				window.location.href = $(this).attr('r')+'?photoIdArray='+photoIdArray().toString();
			}
		});
	}

	/*
	Loads the src value in img tag and attaches click handlers for images and clusters
	*/
	function processImages() {
		$('#allImages').find('div.ui-photo-block.n-p').each(function(){
			clusterClickHandler($(this).find('div.i'));
			$(this).removeClass('n-p');
			});
		updateMoreLink();
	}

	function updateMoreLink(){
		if ($('div.ui-photo-block.hidden').length > 0){
			if ($('div.ui-more').hasClass('hidden')) {
				//$('div.ui-loader').addClass('hidden');
				hideDiv($('div.ui-loader'));
				showDiv($('div.ui-more'));
				moreClickHandler();	
			}
		}
		else if ($('div.ui-loader').length > 0){
			$('div.ui-loader').show();
			hideDiv($('div.ui-more'));
		}
		else {
			hideDiv($('div.ui-more'));
		}
	}

	/*
	Shows preloaded images
	*/
	function moreClickHandler(){
		$('div.ui-more').click(function(){
			if (reversed){
				divs = $($('div.ui-photo-block.hidden').get().reverse());
			}
			else {
				divs = $('div.ui-photo-block.hidden');
			}
			$(divs).slice(0,6).each(function(){
				showDiv($(this));
			});
			updateMoreLink();
		});
	}

	/*
	Shows a div and attempts to not scroll the view
	*/
	function showDiv(div){
		curHeight = $(document).height();
		div.removeClass('hidden');
		newHeight = $(document).height();
		if (reversed){
			$(window).scrollTop($(window).scrollTop() + newHeight - curHeight);
		}
	}

	/*
	Hides a div and attempts to not scroll the view
	*/
	function hideDiv(div){
		curHeight = $(document).height();
		div.addClass('hidden');
		newHeight = $(document).height();
		if (reversed){
			newST = $(window).scrollTop() + newHeight - curHeight;
			if (newST > 0){
				$(window).scrollTop(newST);
			}
		}
	}

	// This is for images that came on first load
	$('#allImages').find('div.ui-photo-block.hidden').each(function(){
		$(this).removeClass('hidden');
		});
	if (reversed){
		$('body').scrollTop($(document).height());
	}
	processImages();

	/*
	Infinite scrolling
	*/
	
	$('div.ui-gallery').jscroll({
		nextSelector: 'a.jscroll-next:last',
		debug: false,
		autoTrigger: true,
		{% if resultsDict.reverse %}reverse: true,{% endif %}	
		callback: function(){
			processImages();			
		},
		loadingHtml: '<div class="ui-loader center t hidden"> Loading... </div>'
	});

	/*
	Check to see if there are newer results
	*/
	function checkForNewResultsNow(){
		var lastUpdated = '{{ resultsDict.lastUpdated }}';
		$.ajax({
			url: "/api/newresults_check",
			dataType: "json",
			crossDomain: true,
			data: {
				user_id: "{{ user.id }}",
				last_updated: lastUpdated,
			}
		})
		.then( function ( response ) {
			if (response['newData']){
				showDiv($('div.ui-refresh'));
				refreshClickHandler();
			}
		});
	}
	
	function refreshClickHandler(){
		$('div.ui-refresh').click(function(){
			location.reload();
		});
	}

	if (reversed){
		window.setTimeout(checkForNewResultsNow, 5000);
	}

	</script>
</html>