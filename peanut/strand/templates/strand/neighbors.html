<html> 

<head>
	<title>Neighbors</title> 
	<link rel="stylesheet" type="text/css" href="/static/duffy.css" media="screen" />

	<style>
		.ui-section {
			padding-bottom:4px;
		}
		.ui-sec-header{
			overflow: hidden;
		}
		.ui-sec-head-lhs {
			display: inline-block;
		}
		.ui-sec-head-rhs {
			float: right;
		}
		.ui-sec-users {
			clear: left;
		}
	</style>
	<script src="//code.jquery.com/jquery-1.10.2.min.js"> </script>
	<script src="/static/jquery.timeago.js"></script>	
	<script src="/static/duffy.js"></script>
	<script>
		userId = getURLParameter("user_id")
		url = "/strand/api/neighbors?user_id=" + userId

		console.log("Sending request to " + url)

		$.get(url, function( data ) {
			$.each( data.objects, function( i, objects ) {
				if (objects.type == 'section') {
					row = "";
					userList = [];
					$.each(objects.objects, function( i, photos) {
						if (photos.type == 'photo') {
							row += addPhoto(photos, userList);
						}
						else if (photos.type == 'cluster'){
							row += addCluster(photos.objects, userList);
						}
						else {
							console.log('unknown type detected: ' + photos);
						}
					});
					$("<div class='ui-section'>" + genHeader(objects, userList) + row + "</div>").appendTo("#allImages");	
				}
			});
			$('div.image').each(function(){
				clusterClickHandler($(this));
			});
			$('div.timeago').timeago();
		});

		/*
		Generates the header for a section. Typically custom for each view
		*/

		function genHeader(section, userList){
			html = "";
			$.each( section.objects, function(i, photos ) {
				if (photos.type == 'photo') {
					t = new Date(photos.time_taken * 1000).toISOString();
					return;
				}
				else if (photos.type == 'cluster') {
					$.each(photos.objects, function(i, photos){
						t = new Date(photos.time_taken * 1000).toISOString();
					});
				}
			});
			users = "<div class='ui-sec-users'>" + uniqueUser(userList) + "</div>";
			lhs = "<div class='ui-sec-head-lhs'>"+ section.title + "</div>";
			rhs = "<div class='ui-sec-head-rhs timeago' title='" + t + "'></div>";
			html = "<div class='ui-sec-header'>" + rhs + lhs + users + "</div>";
			return html;
		}

		// Takes an array of duplicates and gives back a unique list
		function uniqueUser(array){
			var flags = [], output = [], l = array.length, i;
			for( i=0; i<l; i++) {
				var val = cleanName(array[i]);
				if( flags[val]) {
					continue;
				}

				flags[val] = true;
				output.push(val);
			}
			return output.join(', ');
		}
		/*
		Cleans names of apostrophes and if multiple words, picks the first one
		*/
		function cleanName(str) {
			if (str.indexOf(' ') > -1) {
				str = str.substr(0, str.indexOf(' '));
			}
			if (str.indexOf("'") > -1) {
				str = str.substr(0, str.indexOf("'"));
			}
			return str;
		}
	</script>
</head>

<body>
	<div class="ui-header"> Your photos </div>
<div class="ui-content">
	<div class="ui-gallery" id="allImages"/>
</div>

</body>


</html>