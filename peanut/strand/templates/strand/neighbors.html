<html> 

<head>
	<title>Neighbors</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
	<link rel="stylesheet" type="text/css" href="/static/duffy.css" media="screen" />


	<style>
		html, body {
			font-family: helveticaNeue;
		}
		.ui-section {
			padding-bottom:4px;
		}
		.ui-sec-header{
			overflow: hidden;
			background-color: #ffffff;
			padding-top: 21px;
			padding-bottom: 21px;
		}
		.ui-sec-head-top {
			width: 100%;
			float:left;
			font-size: 18px;
			color: #000000;
			line-height: 21px;
			letter-spacing: 0px;

		}
		.ui-sec-head-bottom {
			width: 100%;
			float:left;
			font-size: 15px;
			color: #929292;
			line-height: 17px;
			letter-spacing: 0px;			
		}
	</style>
	<script src="//code.jquery.com/jquery-1.10.2.min.js"> </script>
	<script src="/static/jquery.timeago.js"></script>	
	<script src="/static/duffy.js"></script>
	<script>
		userId = getURLParameter("user_id");
		url = "/strand/api/neighbors?user_id=" + userId;
		console.log("Sending request to " + url);

		$.get(url, function( data ) {
			$.each( data.objects, function( i, objects ) {
				if (objects.type == 'section') {
					row = "";
					userList = [];
					$.each(objects.objects, function( i, photos) {
						if (photos.type == 'photo') {
							row += addPhoto(photos, userList);
						}
						else if (photos.type == 'cluster'){
							row += addCluster(photos.objects, userList);
						}
						else {
							console.log('unknown type detected: ' + photos);
						}
					});
					$("<div class='ui-section'>" + genHeader(objects, userList) + row + "</div>").appendTo("#allImages");	
				}
			});
			if (data.objects.length === 0){
				$('div.ui-msg').removeClass('hidden');
			}
			$('div.image').each(function(){
				clusterClickHandler($(this));
			});
			$('span.timeago').timeago();
		});

		/*
		Generates the header for a section. Typically custom for each view
		*/

		function genHeader(section, userList){
			html = "";
			offset = new Date().getTimezoneOffset()*60;
			$.each( section.objects, function(i, photos ) {
				if (photos.type == 'photo') {
					t = new Date((photos.time_taken+offset) * 1000).toISOString();
					return false;
				}
				else if (photos.type == 'cluster') {
					$.each(photos.objects, function(i, photos){
						t = new Date((photos.time_taken+offset) * 1000).toISOString();
						return false;
					});
					return false;
				}
			});
			secTop = "<div class='ui-sec-head-top'>With " + uniqueUser(userList) + "</div>";
			secBottom = "<div class='ui-sec-head-bottom'> <span class='timeago' title='" + t + "'></span> in " + section.title +"</div>";
			html = "<div class='ui-sec-header'>" + secTop + secBottom + "</div>";
			return html;
		}

		// Takes an array of duplicates and gives back a unique list
		function uniqueUser(array){
			var flags = [], output = [], l = array.length, i;
			for( i=0; i<l; i++) {
				var val = cleanName(array[i]);
				if( flags[val]) {
					continue;
				}

				flags[val] = true;
				output.push(val);
			}
			return output.join(', ');
		}
	</script>
</head>

<body>
<div class="ui-content">
	<div class="ui-gallery" id="allImages"/>
	<div class="ui-msg hidden">No photos. Go take some photos!</div>
</div>

</body>


</html>